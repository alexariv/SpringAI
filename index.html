<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Semantic LLM Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap: 0.75rem; }
    body { font-family: system-ui, sans-serif; margin: 1.25rem; }
    .row { margin-bottom: var(--gap); }
    .muted { color: #666; font-size: .9rem; }
    .bar { display:flex; align-items:center; gap:.5rem; }

    .prompt-line { display:flex; align-items:flex-start; gap:var(--gap); }
    .prompt-wrap { flex:0 1 auto; width:520px; max-width:90vw; }
    textarea#prompt {
      width:100%; font-size:1rem; line-height:1.3; padding:.5rem .6rem;
      border:1px solid #ccc; border-radius:.5rem; resize:none; overflow:hidden;
      min-height:2.4rem; max-height:40vh; box-sizing:border-box;
      white-space:pre-wrap; word-break:break-word;
    }
    #send {
      flex:0 0 auto; width:110px; height:2.6rem; font-size:1rem;
      border:1px solid #bbb; border-radius:.5rem; background:#f5f5f5; cursor:pointer;
    }
    #send:disabled { opacity:.6; cursor:not-allowed; }

    .date-range { display:flex; align-items:center; flex-wrap:wrap; gap:0.5rem; }
    .date-range label { font-size:.9rem; }

    .out {
      white-space:pre-wrap; border:1px solid #ccc; padding:.75rem;
      border-radius:.5rem; min-height:6rem; max-width:75%;
    }
    .out.waiting { color:#666; }
  </style>
</head>
<body>
  <div class="bar row">
    <h2>Semantic Log Search</h2>
    <span id="modelName" class="muted">model: loading…</span>
  </div>

  <div class="row date-range">
    <label>
      From:
      <input type="date" id="dateFrom">
    </label>
    <label>
      To:
      <input type="date" id="dateTo">
    </label>
    <button type="button" id="clearRange">Clear range</button>
  </div>

  <div class="row prompt-line">
    <div class="prompt-wrap">
      <textarea id="prompt" placeholder="Enter prompt"></textarea>
    </div>
    <button id="send" type="button">Search</button>
  </div>

  <div class="row muted" id="timing"></div>

  <h2>Results</h2>
  <div id="response" class="out"></div>

  <script>
    const prompts = document.getElementById('prompt');
    const responses = document.getElementById('response');
    const btn = document.getElementById('send');
    const timings = document.getElementById('timing');
    const models = document.getElementById('modelName');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    const clearRangeBtn = document.getElementById('clearRange');

    // Model name
    (async () => {
      try {
        const r = await fetch('/api/model');
        const j = await r.json();
        models.textContent = 'model: ' + (j.model || 'unknown');
      } catch {
        models.textContent = 'model: unknown';
      }
    })();

    function autoresize() {
      prompts.style.height = 'auto';
      prompts.style.height = Math.min(prompts.scrollHeight, window.innerHeight * 0.4) + 'px';
    }
    prompts.addEventListener('input', autoresize);
    autoresize();

    clearRangeBtn.addEventListener('click', () => {
      dateFrom.value = '';
      dateTo.value = '';
    });

    async function send() {
      const query = prompts.value.trim();
      if (!query) return;

      btn.disabled = true;
      responses.textContent = 'Waiting for search results…';
      responses.classList.add('waiting');
      timings.textContent = '';

      const payload = {
        query,
        createdDateFrom: dateFrom.value || null,  // yyyy-MM-dd or null
        createdDateTo: dateTo.value || null
      };

      const t0 = performance.now();
      try {
        const res = await fetch('/api/search/semantic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const t1 = performance.now();

        const totalSec = ((t1 - t0) / 1000).toFixed(2);
        timings.textContent = `Total Time: ${totalSec} s`;

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch {}

        if (!res.ok) {
          responses.textContent = 'Error ' + res.status + ': ' + (data?.message || text);
        } else {
          responses.textContent = JSON.stringify(data, null, 2);
        }
        responses.classList.remove('waiting');
      } catch (err) {
        responses.textContent = 'Error: ' + err.message;
        responses.classList.remove('waiting');
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', send);
    prompts.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>